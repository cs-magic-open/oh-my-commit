<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commit Message</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="container">
      <div class="input-section">
        <div class="input-group">
          <label>
            <span class="label-text">Summary (required)</span>
            <span class="shortcut">⌘Enter to commit</span>
          </label>
          <input type="text" id="summary" placeholder="Summary of changes" />
        </div>
        <div class="input-group">
          <label>
            <span class="label-text">Description</span>
            <span class="shortcut">⇧Enter for new line</span>
          </label>
          <textarea
            id="description"
            placeholder="Detailed description of changes"
          ></textarea>
        </div>
      </div>

      <div class="commit-list">
        <h3>Recent Commits</h3>
        <ul class="commit-items" id="commitList"></ul>
      </div>

      <div class="button-group">
        <button id="cancelButton">Cancel</button>
        <button id="commitButton" disabled>Commit</button>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      let commits = [];
      let isAmendMode = false;
      let activePopover = null;

      function formatDate(date) {
        const now = new Date();
        const inputDate = new Date(date);
        const diff = now - inputDate;

        // Less than a minute
        if (diff < 60000) {
          return "just now";
        }

        // Less than an hour
        if (diff < 3600000) {
          const minutes = Math.floor(diff / 60000);
          return `${minutes}m ago`;
        }

        // Less than a day
        if (diff < 86400000) {
          const hours = Math.floor(diff / 3600000);
          return `${hours}h ago`;
        }

        // Less than a week
        if (diff < 604800000) {
          const days = Math.floor(diff / 86400000);
          return `${days}d ago`;
        }

        // Format as date
        return inputDate.toLocaleDateString();
      }

      function normalizeLineEndings(text) {
        return text.replace(/\r\n|\r|\n/g, "\n");
      }

      function formatCommitMessage(summary, description) {
        let message = summary;
        if (description) {
          message += "\n\n" + description;
        }
        return normalizeLineEndings(message);
      }

      function parseCommitMessage(message) {
        const lines = normalizeLineEndings(message).split("\n");
        const summary = lines[0];
        const description = lines.slice(2).join("\n").trim();
        return { summary, description };
      }

      function showPopover(element, content, position) {
        if (activePopover) {
          activePopover.remove();
        }

        const popover = document.createElement("div");
        popover.className = "commit-popover show";
        popover.textContent = content;

        // 计算位置
        const rect = element.getBoundingClientRect();
        const spaceAbove = rect.top;
        const spaceBelow = window.innerHeight - rect.bottom;

        // 默认显示在下方
        let top = rect.bottom + 8;

        // 如果下方空间不足且上方空间较多，则显示在上方
        if (spaceBelow < 100 && spaceAbove > spaceBelow) {
          top = rect.top - 8 - popover.offsetHeight;
        }

        popover.style.left = `${rect.left}px`;
        popover.style.top = `${top}px`;

        document.body.appendChild(popover);
        activePopover = popover;
      }

      function hidePopover() {
        if (activePopover) {
          activePopover.remove();
          activePopover = null;
        }
      }

      function createCommitElement(
        commit,
        isPreview = false,
        isToBeAmended = false
      ) {
        const li = document.createElement("li");
        li.className = "commit-item";
        if (isPreview) {
          li.classList.add("preview");
        }
        if (isToBeAmended) {
          li.classList.add("to-be-amended");
        }

        const { summary, description } = parseCommitMessage(commit.message);

        const content = document.createElement("div");
        content.className = "commit-item-content";

        // Column 1: Indicator
        const indicator = document.createElement("div");
        indicator.className = `commit-indicator ${
          isPreview
            ? "preview-indicator"
            : isToBeAmended
            ? "amend-indicator"
            : ""
        }`;

        // Column 2: Message
        const message = document.createElement("div");
        message.className = "commit-message";
        if (description) {
          message.classList.add("has-body");
          // Add hover handlers for popover
          message.addEventListener("mouseenter", () => {
            showPopover(message, commit.message);
          });
          message.addEventListener("mouseleave", () => {
            hidePopover();
          });
        }
        message.textContent = summary;

        // Column 3: Date
        const date = document.createElement("span");
        date.className = "commit-date";
        date.textContent = formatDate(commit.date);

        // Column 4: Hash
        const hash = document.createElement("span");
        hash.className = "commit-hash";
        hash.textContent = commit.hash.substring(0, 7);
        hash.title = `Click to copy full hash: ${commit.hash}`;
        hash.addEventListener("click", (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(commit.hash);
          vscode.postMessage({
            command: "showInfo",
            text: "Commit hash copied to clipboard",
          });
        });

        content.appendChild(indicator);
        content.appendChild(message);
        content.appendChild(date);
        content.appendChild(hash);
        li.appendChild(content);

        if (!isPreview) {
          li.addEventListener("click", () => {
            const { summary, description } = parseCommitMessage(commit.message);
            document.getElementById("summary").value = summary;
            document.getElementById("description").value = description || "";
            updateCommitButton();
          });
        }

        return li;
      }

      function updateCommitList() {
        const list = document.getElementById("commitList");
        list.innerHTML = "";

        // Add preview if there's input
        const summary = document.getElementById("summary").value.trim();
        const description = document.getElementById("description").value.trim();
        if (summary) {
          const previewCommit = {
            hash: "preview",
            date: new Date().toISOString(),
            message: formatCommitMessage(summary, description),
          };
          list.appendChild(createCommitElement(previewCommit, true));
        }

        // Add commit to be amended if in amend mode
        if (isAmendMode && commits.length > 0) {
          list.appendChild(createCommitElement(commits[0], false, true));
        }

        // Add recent commits
        commits.slice(isAmendMode ? 1 : 0).forEach((commit) => {
          list.appendChild(createCommitElement(commit));
        });
      }

      function updateCommitButton() {
        const summary = document.getElementById("summary").value.trim();
        document.getElementById("commitButton").disabled = !summary;
      }

      // Handle input events
      document.getElementById("summary").addEventListener("input", () => {
        updateCommitButton();
        updateCommitList();
      });

      document.getElementById("description").addEventListener("input", () => {
        updateCommitList();
      });

      // Handle button clicks
      document.getElementById("commitButton").addEventListener("click", () => {
        const summary = document.getElementById("summary").value.trim();
        const description = document.getElementById("description").value.trim();
        vscode.postMessage({
          command: "commit",
          message: formatCommitMessage(summary, description),
        });
      });

      document.getElementById("cancelButton").addEventListener("click", () => {
        vscode.postMessage({ command: "cancel" });
      });

      // Handle keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.metaKey || e.ctrlKey) && !e.shiftKey) {
          const commitButton = document.getElementById("commitButton");
          if (!commitButton.disabled) {
            commitButton.click();
          }
          e.preventDefault();
        }
      });

      // Handle messages from extension
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setCommits":
            commits = message.commits;
            updateCommitList();
            break;
          case "setInitialMessage":
            const { summary, description } = parseCommitMessage(
              message.message
            );
            document.getElementById("summary").value = summary;
            document.getElementById("description").value = description || "";
            updateCommitButton();
            updateCommitList();
            break;
          case "setAmendMode":
            isAmendMode = message.isAmendMode;
            updateCommitList();
            break;
        }
      });
    </script>
  </body>
</html>
