<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commit Message</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="container">
      <div class="input-section">
        <div class="input-group">
          <label>
            <span class="label-text">Summary (required)</span>
            <span class="shortcut">⌘Enter to commit</span>
          </label>
          <input type="text" id="summary" placeholder="Summary of changes" />
        </div>
        <div class="input-group">
          <label>
            <span class="label-text">Description</span>
            <span class="shortcut">⇧Enter for new line</span>
          </label>
          <textarea
            id="description"
            placeholder="Detailed description of changes"
          ></textarea>
        </div>
      </div>

      <div class="commit-list">
        <h3>Recent Commits</h3>
        <ul class="commit-items" id="commitList"></ul>
      </div>

      <div class="button-group">
        <button id="cancelButton">Cancel</button>
        <button id="commitButton" disabled>Commit</button>
      </div>
    </div>

    <script type="module" src="./components/CommitItem.js"></script>
    <script type="module">
      {
        {
          inject: "components";
        }
      }
      const vscode = acquireVsCodeApi();
      let commits = [];
      let isAmendMode = false;
      let activePopover = null;

      function showPopover(element, content, position) {
        if (activePopover) {
          activePopover.remove();
        }

        const popover = document.createElement("div");
        popover.className = "popover";
        popover.textContent = content;

        // Position the popover
        const rect = element.getBoundingClientRect();
        popover.style.top = `${rect.bottom + 5}px`;
        popover.style.left = `${rect.left}px`;

        document.body.appendChild(popover);
        activePopover = popover;
      }

      function hidePopover() {
        if (activePopover) {
          activePopover.remove();
          activePopover = null;
        }
      }

      function normalizeLineEndings(text) {
        return text.replace(/\r\n|\r|\n/g, "\n");
      }

      function formatCommitMessage(summary, description) {
        let message = summary;
        if (description) {
          message += "\n\n" + description;
        }
        return normalizeLineEndings(message);
      }

      function parseCommitMessage(message) {
        const lines = normalizeLineEndings(message).split("\n");
        const summary = lines[0];
        const description = lines.slice(2).join("\n").trim();
        return { summary, description };
      }

      function updateCommitList() {
        const list = document.getElementById("commitList");
        list.innerHTML = "";

        // Add preview if there's input
        const summary = document.getElementById("summary").value.trim();
        const description = document.getElementById("description").value.trim();
        if (summary) {
          const previewCommit = {
            hash: "preview",
            message: formatCommitMessage(summary, description),
            date: new Date().toISOString(),
          };

          const previewItem = document.createElement("commit-item");
          previewItem.setAttribute("hash", previewCommit.hash);
          previewItem.setAttribute("message", previewCommit.message);
          previewItem.setAttribute("date", previewCommit.date);
          previewItem.setAttribute("is-preview", "");
          list.appendChild(previewItem);
        }

        // Add actual commits
        commits.forEach((commit, index) => {
          const commitItem = document.createElement("commit-item");
          commitItem.setAttribute("hash", commit.hash);
          commitItem.setAttribute("message", commit.message);
          commitItem.setAttribute("date", commit.date);
          if (isAmendMode && index === 0) {
            commitItem.setAttribute("is-amend", "");
          }

          commitItem.addEventListener("showPopover", (e) => {
            showPopover(e.target, e.detail.message);
          });

          commitItem.addEventListener("hidePopover", () => {
            hidePopover();
          });

          commitItem.addEventListener("commitSelect", (e) => {
            const { summary, description } = parseCommitMessage(
              e.detail.message
            );
            document.getElementById("summary").value = summary;
            document.getElementById("description").value = description || "";
            updateCommitButton();
          });

          list.appendChild(commitItem);
        });
      }

      function updateCommitButton() {
        const summary = document.getElementById("summary").value.trim();
        document.getElementById("commitButton").disabled = !summary;
      }

      // Handle input events
      document.getElementById("summary").addEventListener("input", () => {
        updateCommitButton();
        updateCommitList();
      });

      document.getElementById("description").addEventListener("input", () => {
        updateCommitList();
      });

      // Handle button clicks
      document.getElementById("commitButton").addEventListener("click", () => {
        const summary = document.getElementById("summary").value.trim();
        const description = document.getElementById("description").value.trim();
        vscode.postMessage({
          command: "commit",
          message: formatCommitMessage(summary, description),
        });
      });

      document.getElementById("cancelButton").addEventListener("click", () => {
        vscode.postMessage({ command: "cancel" });
      });

      // Handle messages from extension
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setCommits":
            commits = message.commits;
            updateCommitList();
            break;
          case "setAmendMode":
            isAmendMode = message.isAmendMode;
            updateCommitList();
            break;
        }
      });
    </script>
  </body>
</html>
