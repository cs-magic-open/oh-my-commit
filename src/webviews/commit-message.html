<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline'; script-src ${webview.cspSource} 'nonce-${nonce}';" />
    <title>Commit Message</title>
    <style>
      :root {
        --vscode-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        --vscode-font-size: 13px;
        --vscode-font-weight: normal;
        --vscode-editor-background: var(--vscode-background);
        --vscode-foreground: var(--vscode-foreground);
        --vscode-input-background: var(--vscode-input-background);
        --vscode-input-foreground: var(--vscode-input-foreground);
        --vscode-input-border: var(--vscode-input-border);
        --vscode-button-background: var(--vscode-button-background);
        --vscode-button-foreground: var(--vscode-button-foreground);
        --vscode-button-hoverBackground: var(--vscode-button-hoverBackground);
        --vscode-list-hoverBackground: var(--vscode-list-hoverBackground);
        --vscode-widget-border: var(--vscode-widget-border);
        --vscode-descriptionForeground: var(--vscode-descriptionForeground);
        --vscode-focusBorder: var(--vscode-focusBorder);
        --vscode-diffEditor-insertedTextBackground: var(--vscode-diffEditor-insertedTextBackground);
      }

      body {
        padding: 0;
        margin: 0;
      }

      .container {
        padding: var(--spacing-lg);
        max-width: 800px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <commit-input css-uri="%webview.cspSource%/components/CommitInput.css"></commit-input>
      <commit-list 
        css-uri="%webview.cspSource%/components/CommitList.css" 
        item-css-uri="%webview.cspSource%/components/CommitItem.css">
      </commit-list>
      <action-buttons css-uri="%webview.cspSource%/components/ActionButtons.css" disabled></action-buttons>
    </div>

    <script nonce="${nonce}" type="module">
      const vscode = acquireVsCodeApi();

      // Utils
      function normalizeLineEndings(text) {
        return text?.replace(/\r\n|\r|\n/g, "\n") || "";
      }

      function formatCommitMessage(summary, description) {
        let message = summary || "";
        if (description) {
          message += "\n\n" + description;
        }
        return normalizeLineEndings(message);
      }

      function parseCommitMessage(message) {
        if (!message) return { summary: "", description: "" };
        
        const lines = normalizeLineEndings(message).split("\n");
        const summary = lines[0] || "";
        const description = lines.slice(2).join("\n").trim();
        return { summary, description };
      }

      // UI Components
      const commitInput = document.querySelector("commit-input");
      const commitList = document.querySelector("commit-list");
      const actionButtons = document.querySelector("action-buttons");

      // Event Handlers
      function handleInputChange(e) {
        const { summary, description } = e.detail;
        const hasInput = summary.trim().length > 0;
        actionButtons.setDisabled(!hasInput);
      }

      // Event Listeners
      commitInput.addEventListener("input", handleInputChange);

      commitList.addEventListener("commitSelect", (e) => {
        const { summary, description } = parseCommitMessage(e.detail.message);
        commitInput.setValue(summary, description);
      });

      actionButtons.addEventListener("commit", () => {
        const { summary, description } = commitInput.getValue();
        vscode.postMessage({
          command: "commit",
          message: formatCommitMessage(summary.trim(), description.trim()),
        });
      });

      actionButtons.addEventListener("cancel", () => {
        vscode.postMessage({ command: "cancel" });
      });

      // Handle messages from extension
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setCommits":
            commitList.setCommits(message.commits);
            break;
          case "setAmendMode":
            commitList.setAttribute("is-amend-mode", message.isAmendMode);
            break;
          case "setInitialMessage":
            const { summary, description } = parseCommitMessage(message.message);
            commitInput.setValue(summary, description);
            break;
        }
      });
    </script>

    <script nonce="${nonce}" type="module" src="%webview.cspSource%/components/CommitItem.js"></script>
    <script nonce="${nonce}" type="module" src="%webview.cspSource%/components/CommitInput.js"></script>
    <script nonce="${nonce}" type="module" src="%webview.cspSource%/components/CommitList.js"></script>
    <script nonce="${nonce}" type="module" src="%webview.cspSource%/components/ActionButtons.js"></script>
  </body>
</html>
