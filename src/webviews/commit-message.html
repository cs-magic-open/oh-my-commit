<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commit Message</title>
    <style>
      body {
        font-family: var(--vscode-font-family);
        font-size: var(--vscode-font-size);
        color: var(--vscode-foreground);
        padding: 20px;
        line-height: 1.5;
        margin: 0;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .input-section {
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        padding: 16px;
      }

      .input-group {
        margin-bottom: 16px;
      }

      .input-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        color: var(--vscode-input-foreground);
        font-weight: 500;
      }

      .label-text {
        flex: 1;
      }

      .shortcut {
        font-size: 12px;
        opacity: 0.7;
        padding: 2px 6px;
        background: var(--vscode-badge-background);
        border-radius: 3px;
        margin-left: 8px;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--vscode-input-border);
        background: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        border-radius: 4px;
        font-family: var(--vscode-editor-font-family);
        font-size: var(--vscode-editor-font-size);
        line-height: 1.4;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--vscode-focusBorder);
      }

      .preview-section {
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        padding: 16px;
      }

      .preview-section.amend-mode {
        border: 2px solid #ffa500;
        position: relative;
      }

      .preview-section.amend-mode::before {
        content: "Amend Mode";
        position: absolute;
        top: -12px;
        left: 16px;
        background: var(--vscode-editor-background);
        padding: 0 8px;
        color: #ffa500;
        font-size: 12px;
        font-weight: bold;
        border-radius: 3px;
      }

      .preview-content {
        font-family: var(--vscode-editor-font-family);
        white-space: pre-wrap;
        word-break: break-word;
        padding: 12px;
        background: var(--vscode-textBlockQuote-background);
        border-left: 4px solid var(--vscode-textBlockQuote-border);
        border-radius: 4px;
        margin-top: 8px;
      }

      .commit-list {
        margin-top: 20px;
      }

      .commit-list h3 {
        margin: 0 0 12px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .commit-list h3::before {
        content: "↺";
        font-size: 1.2em;
      }

      .commit-items {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }

      .commit-item {
        padding: 12px;
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .commit-item:hover {
        transform: translateX(4px);
        border-color: var(--vscode-focusBorder);
      }

      .commit-item.to-be-amended {
        border: 2px solid #ffa500;
        background: color-mix(
          in srgb,
          var(--vscode-editor-background) 95%,
          #ffa500
        );
      }

      .commit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.9em;
      }

      .commit-hash {
        color: var(--vscode-textPreformat-foreground);
        font-family: var(--vscode-editor-font-family);
        padding: 2px 6px;
        background: var(--vscode-badge-background);
        border-radius: 3px;
      }

      .commit-date {
        color: var(--vscode-descriptionForeground);
      }

      .commit-message {
        color: var(--vscode-foreground);
        line-height: 1.4;
      }

      .amend-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
        color: #ffa500;
        font-size: 0.9em;
        font-weight: 500;
      }

      .amend-indicator::before {
        content: "↺";
        font-size: 1.2em;
      }

      .button-group {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--vscode-panel-border);
      }

      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #commitButton {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }

      #commitButton:hover:not(:disabled) {
        background: var(--vscode-button-hoverBackground);
      }

      #cancelButton {
        background: var(--vscode-button-secondaryBackground);
        color: var(--vscode-button-secondaryForeground);
      }

      #cancelButton:hover {
        background: var(--vscode-button-secondaryHoverBackground);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .amend-mode .preview-content {
        animation: pulse 2s infinite;
      }

      /* 响应式设计 */
      @media (min-width: 768px) {
        .container {
          grid-template-columns: 3fr 2fr;
        }

        .input-section {
          grid-column: 1;
        }

        .preview-section,
        .commit-list {
          grid-column: 2;
        }

        .button-group {
          grid-column: 1 / -1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="input-section">
        <div class="input-group">
          <label>
            <span class="label-text">Commit Message</span>
          </label>
          <input
            type="text"
            id="titleInput"
            placeholder="Enter a concise description"
          />
        </div>
        <div class="input-group">
          <label>
            <span class="label-text">Extended Description</span>
            <span class="shortcut">(optional)</span>
          </label>
          <textarea
            id="descriptionInput"
            placeholder="Enter a detailed description"
          ></textarea>
        </div>
      </div>

      <div class="preview-section">
        <h3>Commit Preview</h3>
        <div class="preview-content">No commit message yet</div>
      </div>

      <div class="commit-list">
        <h3>Recent Commits</h3>
        <ul class="commit-items"></ul>
      </div>

      <div class="button-group">
        <button id="cancelButton">
          Cancel <span class="shortcut">Esc</span>
        </button>
        <button id="commitButton" disabled>
          Commit Changes <span class="shortcut">⌘↵</span>
        </button>
      </div>
    </div>
    <script>
      const vscode = acquireVsCodeApi();

      // 简单的时间格式化函数
      function formatTimeAgo(date) {
        if (!date) return "";

        const now = new Date();
        const past = new Date(date);
        const diffMs = now - past;

        // 转换为各种时间单位
        const diffSecs = Math.floor(diffMs / 1000);
        const diffMins = Math.floor(diffSecs / 60);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        const diffMonths = Math.floor(diffDays / 30);
        const diffYears = Math.floor(diffDays / 365);

        // 返回最适合的时间格式
        if (diffSecs < 60) return "just now";
        if (diffMins < 60) return `${diffMins} minutes ago`;
        if (diffHours < 24) return `${diffHours} hours ago`;
        if (diffDays < 30) return `${diffDays} days ago`;
        if (diffMonths < 12) return `${diffMonths} months ago`;
        return `${diffYears} years ago`;
      }

      let state = {
        isAmend: false,
        message: "",
        commits: [],
        title: "",
        description: "",
      };

      // 更新整个 UI 的函数
      function updateUI() {
        const previewSection = document.querySelector(".preview-section");
        const previewContent = document.querySelector(".preview-content");
        const commitList = document.querySelector(".commit-items");
        const titleInput = document.querySelector("#titleInput");
        const descriptionInput = document.querySelector("#descriptionInput");

        if (previewSection) {
          previewSection.className =
            "preview-section" + (state.isAmend ? " amend-mode" : "");
        }

        if (previewContent) {
          const message =
            state.title + (state.description ? "\n\n" + state.description : "");
          previewContent.textContent = message || "No commit message yet";
        }

        if (commitList) {
          commitList.innerHTML = updateCommitList(state.commits);
        }

        if (titleInput) {
          titleInput.value = state.title;
        }

        if (descriptionInput) {
          descriptionInput.value = state.description;
        }

        // 更新按钮状态
        const commitButton = document.querySelector("#commitButton");
        if (commitButton) {
          commitButton.disabled = !state.title.trim();
          if (state.isAmend) {
            commitButton.textContent = "Amend Commit";
          }
        }
      }

      // 更新预览的函数
      function updatePreview() {
        const titleInput = document.querySelector("#titleInput");
        const descriptionInput = document.querySelector("#descriptionInput");

        if (titleInput && descriptionInput) {
          state.title = titleInput.value.trim();
          state.description = descriptionInput.value.trim();
          updateUI();
        }
      }

      function isAmendMode() {
        return state.isAmend;
      }

      function updateCommitList(commits) {
        if (!commits || !Array.isArray(commits)) return "";

        return commits
          .map(
            (commit, index) => `
          <li class="commit-item ${
            index === 0 && isAmendMode() ? "to-be-amended" : ""
          }" onclick="useCommitMessage(this)" data-commit='${JSON.stringify(
              commit
            ).replace(/'/g, "&apos;")}'>
            ${
              index === 0 && isAmendMode()
                ? '<div class="amend-indicator">This commit will be amended</div>'
                : ""
            }
            <div class="commit-header">
              <span class="commit-hash">${commit.hash.substring(0, 7)}</span>
              <span class="commit-date" data-date="${
                commit.date
              }">${formatTimeAgo(commit.date)}</span>
            </div>
            <div class="commit-message">${commit.message}</div>
          </li>
        `
          )
          .join("");
      }

      function useCommitMessage(element) {
        const commit = JSON.parse(element.getAttribute("data-commit"));
        state.title = commit.message;
        state.description = commit.body || "";
        updateUI();
      }

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        const titleInput = document.querySelector("#titleInput");
        const descriptionInput = document.querySelector("#descriptionInput");
        const commitButton = document.querySelector("#commitButton");
        const cancelButton = document.querySelector("#cancelButton");

        if (titleInput) {
          titleInput.addEventListener("input", updatePreview);
        }
        if (descriptionInput) {
          descriptionInput.addEventListener("input", updatePreview);
        }

        if (commitButton) {
          commitButton.addEventListener("click", () => {
            const description = state.description.replace(/\n/g, "\n\n");
            vscode.postMessage({
              type: "commit",
              message: {
                title: state.title,
                description,
              },
            });
          });
        }

        if (cancelButton) {
          cancelButton.addEventListener("click", () => {
            vscode.postMessage({ type: "cancel" });
          });
        }

        // 键盘快捷键
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            vscode.postMessage({ type: "cancel" });
          } else if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
            if (!commitButton.disabled) {
              commitButton.click();
            }
          }
        });
      });

      // 处理来自 VSCode 的消息
      window.addEventListener("message", (event) => {
        const message = event.data;

        switch (message.type) {
          case "init":
            const lines = message.commitMessage.split("\n");
            state.title = lines[0];
            state.description = lines.slice(1).join("\n").trim();
            state.isAmend = message.isAmendMode;
            state.commits = message.recentCommits || [];
            updateUI();
            break;

          case "update":
            state = { ...state, ...message.state };
            updateUI();
            break;
        }
      });
    </script>
  </body>
</html>
